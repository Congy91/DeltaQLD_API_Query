{% extends "base.html" %}
{% block title %}Sites{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-semibold mb-2">Select a Site</h2>
    {% if base_url %}
    <p class="text-gray-500 mb-4">
        Current Base URL:
        <a href="{{ base_url }}" target="_blank" class="text-blue-600 underline font-mono">{{ base_url }}</a>
    </p>
    {% endif %}

    <p class="text-gray-600 mb-1">Choose a site from the list below to view its devices.</p>

    <form id="siteSelectForm" method="POST" class="flex gap-2 max-w-md">
        <select name="site" required class="px-2 py-1 border rounded flex-grow">
            <option value="">Select a site</option>
            {% for site in sites %}
            <option value="{{ site }}" {% if site==selected_site %}selected{% endif %}>{{ site }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="px-3 py-1 delta-btn rounded text-white">Load Devices</button>
    </form>
</div>

<!-- Spinner -->
<div id="loadingSpinner" class="flex justify-center items-center my-4 hidden">
    <div class="w-12 h-12 border-4 border-t-red-500 border-gray-200 rounded-full animate-spin"></div>
    <span class="ml-2 text-gray-700">Loading information...</span>
</div>

{% if devices %}
<div class="mt-8">
    <h2 class="text-2xl font-semibold mb-2 mt-8">Devices found for: {{ selected_site }}</h2>

    <!-- Device count and export -->
    <div class="flex justify-between items-center mb-2">
        <p class="text-gray-600">Devices found: <span id="deviceCount">{{ devices|length }}</span></p>
        <button id="exportBtn" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-blue-700">Export CSV</button>
    </div>

   <div class="mb-4 mt-4 flex flex-col items-center gap-2">
    <input type="text" id="tableSearch" placeholder="Search table..."
        class="px-2 py-1 border rounded w-full max-w-md">

    <div class="flex flex-wrap justify-center gap-2 mt-2">
        <button type="button" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600" data-filter="reset">Reset</button>
        <button type="button" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600" data-filter="delta">Delta</button>
        <button type="button" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" data-filter="3rdparty">3rd Party</button>
        <button type="button" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600" data-filter="red5">Red5</button>
        <button type="button" class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600" data-filter="ebmgr">eBMGR</button>
        <button type="button" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600" data-filter="vav">VAV</button>
        <button type="button" class="px-3 py-1 bg-pink-500 text-white rounded hover:bg-pink-600" data-filter="dfm400p">DFM400P</button>
        <button type="button" class="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600" data-filter="ip">IP Devices</button>
    </div>
</div>



    <!-- Column toggle checkboxes -->
    <div class="mb-4">
        <span class="font-semibold mr-2">Toggle Columns:</span>
        <!--<label class="mr-2"><input type="checkbox" checked data-col="vendorid"> Vendor ID</label>-->
        <label class="mr-2"><input type="checkbox" checked data-col="vendor"> Vendor</label>
        <label class="mr-2"><input type="checkbox" checked data-col="device_id"> Device Number</label>
        <label class="mr-2"><input type="checkbox" checked data-col="display_name"> Device Name</label>
        <label class="mr-2"><input type="checkbox" checked data-col="model_name"> Device Type</label>
        <label class="mr-2"><input type="checkbox" data-col="app_version"> App Version</label>
        <label class="mr-2"><input type="checkbox" data-col="fw_version"> Firmware Revision</label>
        <label class="mr-2"><input type="checkbox" data-col="serial_number"> Serial Number</label>
        <label class="mr-2"><input type="checkbox" data-col="ip1"> IP Address</label>
        <!--<label class="mr-2"><input type="checkbox" data-col="ip2"> IP2</label>-->
        <label class="mr-2"><input type="checkbox" data-col="mac"> MAC Address</label>
    </div>

    <table id="deviceTable" class="w-full border-collapse mt-4">
        <thead>
            <tr class="bg-gray-200 text-left">
                <!--<th class="border px-2 py-1 col-vendorid">Vendor ID</th>-->
                <th class="border px-2 py-1 col-vendor">Vendor</th>
                <th class="border px-2 py-1 col-device_id">Device ID</th>
                <th class="border px-2 py-1 col-display_name">Display Name</th>
                <th class="border px-2 py-1 col-model_name">Model</th>
                <th class="border px-2 py-1 col-app_version">App Version</th>
                <th class="border px-2 py-1 col-fw_version">Firmware Revision</th>
                <th class="border px-2 py-1 col-serial_number">Serial Number</th>
                <th class="border px-2 py-1 col-ip1">IP1</th>
                <!--<th class="border px-2 py-1 col-ip2">IP2</th>-->
                <th class="border px-2 py-1 col-mac">MAC</th>
            </tr>
            <!-- Column filters -->
            <tr class="bg-gray-100 text-left">
                <!--<th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="vendorid"></th>-->
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="vendor"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="device_id"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="display_name">
                </th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="model_name"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="app_version">
                </th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="fw_version"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="serial_number">
                </th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="ip1"></th>
                <!--<th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="ip2"></th>-->
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="mac"></th>
            </tr>
        </thead>
        <tbody>
            {% for d in devices %}
            <tr>
                <!--<td class="border px-2 py-1 col-vendorid">{{ d.vendorid }}</td>-->
                <td class="border px-2 py-1 col-vendor">{{ d.vendor }}</td>
                <td class="border px-2 py-1 col-device_id">{{ d.device_id }}</td>
                <td class="border px-2 py-1 col-display_name">{{ d.display_name }}</td>
                <td class="border px-2 py-1 col-model_name">{{ d.model_name }}</td>
                <td class="border px-2 py-1 col-app_version">{{ d.app_version }}</td>
                <td class="border px-2 py-1 col-fw_version">{{ d.fw_version }}</td>
                <td class="border px-2 py-1 col-serial_number">{{ d.serial_number }}</td>
                <td class="border px-2 py-1 col-ip1">{{ d.ip1 }}</td>
                <!--<td class="border px-2 py-1 col-ip2">{{ d.ip2 }}</td>-->
                <td class="border px-2 py-1 col-mac">{{ d.mac }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("siteSelectForm");
    const spinner = document.getElementById("loadingSpinner");

    form.addEventListener("submit", () => spinner.classList.remove("hidden"));

    const checkboxes = document.querySelectorAll('input[type="checkbox"][data-col]');
    const table = document.getElementById("deviceTable");
    const tbody = table.getElementsByTagName("tbody")[0];
    const rows = Array.from(tbody.getElementsByTagName("tr"));

    function updateColumns() {
        checkboxes.forEach(cb => {
            const colClass = 'col-' + cb.dataset.col;
            document.querySelectorAll('tbody .' + colClass).forEach(cell => cell.style.display = cb.checked ? '' : 'none');
            document.querySelectorAll('thead tr:first-child .' + colClass).forEach(th => th.style.display = cb.checked ? '' : 'none');
            const filterInput = document.querySelector('thead tr:nth-child(2) .column-filter[data-col="' + cb.dataset.col + '"]');
            if (filterInput) filterInput.closest('th').style.display = cb.checked ? '' : 'none';
            localStorage.setItem('col-' + cb.dataset.col, cb.checked);
        });
        updateDeviceCount();
    }

    checkboxes.forEach(cb => {
        const saved = localStorage.getItem('col-' + cb.dataset.col);
        if (saved !== null) cb.checked = saved === 'true';
    });

    updateColumns();
    checkboxes.forEach(cb => cb.addEventListener("change", updateColumns));

    const searchInput = document.getElementById("tableSearch");
    const columnFilters = document.querySelectorAll(".column-filter");

    function filterTable() {
        const globalFilter = searchInput.value.toLowerCase();
        const colFilters = {};
        columnFilters.forEach(input => {
            if (input.value.trim()) {
                colFilters[input.dataset.col] = input.value
                    .toLowerCase()
                    .split(",")
                    .map(v => v.trim())
                    .filter(v => v);
            }
        });

        rows.forEach(row => {
            const cells = row.getElementsByTagName("td");
            let show = true;

            if (globalFilter) {
                show = Array.from(cells).some(c => c.textContent.toLowerCase().includes(globalFilter));
            }

            if (show) {
                for (let j = 0; j < cells.length; j++) {
                    const colClass = cells[j].className.split(' ').find(c => c.startsWith('col-'));
                    const colName = colClass ? colClass.replace('col-', '') : null;
                    if (colName && colFilters[colName]) {
                        const cellText = cells[j].textContent.toLowerCase();
                        const match = colFilters[colName].some(val => {
                            if (val === '!ip') return cellText.trim() !== '';
                            if (val.startsWith('!')) return !cellText.includes(val.substring(1));
                            return cellText.includes(val);
                        });
                        if (!match) {
                            show = false;
                            break;
                        }
                    }
                }
            }

            row.style.display = show ? "" : "none";
        });

        updateDeviceCount();
    }

    const filterButtons = document.querySelectorAll('button[data-filter]');
    filterButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const filter = btn.dataset.filter;
            searchInput.value = '';
            columnFilters.forEach(input => input.value = '');

            switch (filter) {
                case "reset": break;
                case "delta": columnFilters.forEach(input => { if (input.dataset.col === 'vendor') input.value = 'delta controls'; }); break;
                case "3rdparty": columnFilters.forEach(input => { if (input.dataset.col === 'vendor') input.value = '!delta controls'; }); break;
                case "red5": columnFilters.forEach(input => { if (input.dataset.col === 'model_name') input.value = 'red5'; }); break;
                case "ebmgr": columnFilters.forEach(input => { if (input.dataset.col === 'model_name') input.value = 'ebmgr'; }); break;
                case "vav": columnFilters.forEach(input => { if (input.dataset.col === 'model_name') input.value = 'ezv,dvc,v440,v100'; }); break;
                case "dfm400p": columnFilters.forEach(input => { if (input.dataset.col === 'model_name') input.value = '400p'; }); break;
                case "ip": columnFilters.forEach(input => { if (input.dataset.col === 'ip1') input.value = '!ip'; }); break;
            }

            filterTable();
        });
    });

    function updateDeviceCount() {
        const visibleRows = rows.filter(row => row.style.display !== 'none').length;
        document.getElementById('deviceCount').textContent = visibleRows;
    }

    searchInput.addEventListener("input", filterTable);
    columnFilters.forEach(input => input.addEventListener("input", filterTable));

    // --- Export XLSX ---
document.getElementById("exportBtn").addEventListener("click", () => {
    const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
    if (!visibleRows.length) return;

    const cols = Array.from(table.querySelectorAll("thead tr:first-child th")).filter(th => th.style.display !== 'none');
    
    // Map your visible columns to desired Excel column names
    const colNameMap = {
        'vendor': 'Vendor',
        'device_id': 'Device Number',
        'display_name': 'Device Name',
        'model_name': 'Device Type',
        'app_version': 'App Version',
        'fw_version': 'Firmware',
        'serial_number': 'Serial Number',
        'ip1': 'IP Address',
        'mac': 'MAC Address',
        'ip2': 'IP Address 2',
    };

    const colKeys = cols.map(th => Array.from(th.classList).find(c => c.startsWith('col-')).replace('col-', ''));
    const excelCols = colKeys.map(key => colNameMap[key] || key);

    // Build data array
    const data = [excelCols];
    visibleRows.forEach(row => {
        const cells = Array.from(row.querySelectorAll("td")).filter(td => td.style.display !== 'none');
        const rowData = cells.map(td => td.textContent.trim());
        data.push(rowData);
    });

    // Create worksheet & workbook
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Devices");

    // Export file
    XLSX.writeFile(wb, "devices_export.xlsx");
});


        // --- Column sorting with arrow indicators ---
        let sortCol = null;
        let sortDir = 1; // 1 = asc, -1 = desc

        table.querySelectorAll('thead tr:first-child th').forEach(th => {
            th.style.cursor = 'pointer';
            
            // Create a span to hold the arrow
            let arrowSpan = document.createElement('span');
            arrowSpan.style.marginLeft = '4px';
            th.appendChild(arrowSpan);

            th.addEventListener('click', () => {
                const colClass = Array.from(th.classList).find(c => c.startsWith('col-'));
                if (!colClass) return;
                const colIndex = Array.from(th.parentNode.children).indexOf(th);

                if (sortCol === colIndex) sortDir = -sortDir; // toggle
                else sortDir = 1;
                sortCol = colIndex;

                // Remove arrow from all headers
                table.querySelectorAll('thead tr:first-child th span').forEach(span => span.textContent = '');

                // Add arrow to current header
                arrowSpan.textContent = sortDir === 1 ? '▲' : '▼';

                const sortedRows = rows.slice().sort((a, b) => {
                    const aText = a.children[colIndex].textContent.trim().toLowerCase();
                    const bText = b.children[colIndex].textContent.trim().toLowerCase();
                    if (!isNaN(aText) && !isNaN(bText)) return sortDir * (Number(aText) - Number(bText));
                    return sortDir * aText.localeCompare(bText);
                });

                sortedRows.forEach(row => tbody.appendChild(row));
            });
        });
});
</script>


{% endblock %}