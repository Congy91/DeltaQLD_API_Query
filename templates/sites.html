{% extends "base.html" %}
{% block title %}Sites{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-semibold mb-2">Select a Site</h2>
    {% if base_url %}
    <p class="text-gray-500 mb-4">
        Current Base URL:
        <a href="{{ base_url }}" target="_blank" class="text-blue-600 underline font-mono">{{ base_url }}</a>
    </p>
    {% endif %}

    <p class="text-gray-600 mb-1">Choose a site from the list below to view its devices.</p>

    <form id="siteSelectForm" method="POST" class="flex gap-2 max-w-md">
        <select name="site" required class="px-2 py-1 border rounded flex-grow">
            <option value="">Select a site</option>
            {% for site in sites %}
            <option value="{{ site }}" {% if site==selected_site %}selected{% endif %}>{{ site }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="px-3 py-1 delta-btn rounded text-white">Load Devices</button>
    </form>
</div>

<!-- Spinner -->
<div id="loadingSpinner" class="flex justify-center items-center my-4 hidden">
    <div class="w-12 h-12 border-4 border-t-red-500 border-gray-200 rounded-full animate-spin"></div>
    <span class="ml-2 text-gray-700">Loading information...</span>
</div>

{% if devices %}
<div class="mt-8">
    <h2 class="text-2xl font-semibold mb-2 mt-8">Devices found for: {{ selected_site }}</h2>

    <!-- Device count and export -->
    <div class="flex justify-between items-center mb-2">
        <p class="text-gray-600">Devices found: <span id="deviceCount">{{ devices|length }}</span></p>
        <button id="exportBtn" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-blue-700">Export CSV</button>
    </div>

    <div class="mb-4 mt-4 flex flex-col items-center gap-2">
        <input type="text" id="tableSearch" placeholder="Search table..." class="px-2 py-1 border rounded w-full max-w-md">

        <div class="flex flex-wrap justify-center gap-2 mt-2">
            <button type="button" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600" data-filter="reset">Reset</button>
            <button type="button" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600" data-filter="delta">Delta</button>
            <button type="button" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" data-filter="3rdparty">3rd Party</button>
            <button type="button" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600" data-filter="red5">Red5</button>
            <button type="button" class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600" data-filter="ebmgr">eBMGR</button>
            <button type="button" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600" data-filter="vav">VAV</button>
            <button type="button" class="px-3 py-1 bg-pink-500 text-white rounded hover:bg-pink-600" data-filter="dfm400p">DFM400P</button>
            <button type="button" class="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600" data-filter="ip">IP Devices</button>
        </div>
    </div>

    <!-- Column toggle checkboxes -->
    <div class="mb-4 overflow-auto max-h-42 border p-2 rounded flex flex-wrap gap-2">
        <span class="font-semibold w-full mb-1">Toggle Columns:</span>
        <label class="mr-2"><input type="checkbox" checked data-col="vendor"> Vendor</label>
        <label class="mr-2"><input type="checkbox" checked data-col="device_id"> Device Number</label>
        <label class="mr-2"><input type="checkbox" checked data-col="display_name"> Device Name</label>
        <label class="mr-2"><input type="checkbox" checked data-col="model_name"> Device Type</label>
        <label class="mr-2"><input type="checkbox" data-col="app_version"> App Version</label>
        <label class="mr-2"><input type="checkbox" data-col="fw_version"> Firmware Revision</label>
        <label class="mr-2"><input type="checkbox" data-col="serial_number"> Serial Number</label>
        <label class="mr-2"><input type="checkbox" data-col="ip1"> IP Address</label>
        <label class="mr-2"><input type="checkbox" data-col="mac"> MAC Address</label>

        <!-- VAV points - now visible -->
        <span class="font-semibold w-full mb-1">VAV Related Points</span>
        <label class="mr-2"><input type="checkbox" data-col="vav_box_size"> VAV Box Size</label>
        <label class="mr-2"><input type="checkbox" data-col="damper_runtime"> Damper Runtime</label>
        <label class="mr-2"><input type="checkbox" data-col="cooling_min_setpoint"> Cooling Min Setpoint</label>
        <label class="mr-2"><input type="checkbox" data-col="cooling_max_setpoint"> Cooling Max Setpoint</label>
        <label class="mr-2"><input type="checkbox" data-col="heating_min_setpoint"> Heating Min Setpoint</label>
        <label class="mr-2"><input type="checkbox" data-col="heating_max_setpoint"> Heating Max Setpoint</label>
        <label class="mr-2"><input type="checkbox" data-col="standby_airflow"> Standby Airflow Setpoint</label>
        <label class="mr-2"><input type="checkbox" data-col="damper_sensor"> Damper Sensor</label>
        <label class="mr-2"><input type="checkbox" data-col="controller_airflow"> Controller Airflow</label>
        <label class="mr-2"><input type="checkbox" data-col="airflow_setpoint"> Airflow Setpoint</label>
        <label class="mr-2"><input type="checkbox" data-col="damper_position"> Damper Position</label>
        <label class="mr-2"><input type="checkbox" data-col="damper_sensor_calibration"> Damper Sensor Calibration</label>
        <label class="mr-2"><input type="checkbox" data-col="flow_factor"> Flow Factor</label>
        <label class="mr-2"><input type="checkbox" data-col="space_temp"> Space Temp</label>
        <label class="mr-2"><input type="checkbox" data-col="space_temp_setpoint"> Space Temp Setpoint</label>
        <label class="mr-2"><input type="checkbox" data-col="discharge_temp"> Discharge Temp</label>
    </div>


    <table id="deviceTable" class="w-full border-collapse mt-4">
        <thead>
            <tr class="bg-gray-200 text-left">
                <th class="border px-2 py-1 col-vendor">Vendor</th>
                <th class="border px-2 py-1 col-device_id">Device ID</th>
                <th class="border px-2 py-1 col-display_name">Display Name</th>
                <th class="border px-2 py-1 col-model_name">Model</th>
                <th class="border px-2 py-1 col-app_version">App Version</th>
                <th class="border px-2 py-1 col-fw_version">Firmware Revision</th>
                <th class="border px-2 py-1 col-serial_number">Serial Number</th>
                <th class="border px-2 py-1 col-ip1">IP1</th>
                <th class="border px-2 py-1 col-mac">MAC</th>
                <!-- VAV columns -->
                <th class="border px-2 py-1 col-vav_box_size">VAV Box Size (in)</th>
                <th class="border px-2 py-1 col-damper_runtime">Damper Runtime (sec)</th>
                <th class="border px-2 py-1 col-cooling_min_setpoint">Cooling Min Setpoint (L/s)</th>
                <th class="border px-2 py-1 col-cooling_max_setpoint">Cooling Max Setpoint (L/s)</th>
                <th class="border px-2 py-1 col-heating_min_setpoint">Heating Min Setpoint (L/s)</th>
                <th class="border px-2 py-1 col-heating_max_setpoint">Heating Max Setpoint (L/s)</th>
                <th class="border px-2 py-1 col-standby_airflow">Standby Airflow Setpoint (L/s)</th>
                <th class="border px-2 py-1 col-damper_sensor">Damper Sensor (Pa)</th>
                <th class="border px-2 py-1 col-controller_airflow">Controller Airflow (L/s)</th>
                <th class="border px-2 py-1 col-airflow_setpoint">Airflow Setpoint (L/s)</th>
                <th class="border px-2 py-1 col-damper_position">Damper Position (%)</th>
                <th class="border px-2 py-1 col-damper_sensor_calibration">Damper Sensor Calibration (Pa)</th>
                <th class="border px-2 py-1 col-flow_factor">Flow Factor (%)</th>
                <th class="border px-2 py-1 col-space_temp">Space Temp (°C)</th>
                <th class="border px-2 py-1 col-space_temp_setpoint">Space Temp Setpoint (°C)</th>
                <th class="border px-2 py-1 col-discharge_temp">Discharge Temp (°C)</th>

            </tr>
            <tr class="bg-gray-100 text-left">
                <!-- filter inputs same as above -->
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="vendor"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="device_id"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="display_name"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="model_name"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="app_version"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="fw_version"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="serial_number"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="ip1"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="mac"></th>
                <!-- VAV filters -->
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="vav_box_size"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="damper_runtime"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="cooling_min_setpoint"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="cooling_max_setpoint"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="heating_min_setpoint"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="heating_max_setpoint"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="standby_airflow"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="damper_sensor"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="controller_airflow"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="airflow_setpoint"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="damper_position"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="damper_sensor_calibration"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="flow_factor"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="space_temp"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="space_temp_setpoint"></th>
                <th class="border px-2 py-1"><input type="text" class="column-filter w-full" data-col="discharge_temp"></th>
            </tr>
        </thead>
        <tbody>
            {% for d in devices %}
            <tr>
                <td class="border px-2 py-1 col-vendor">{{ d.vendor }}</td>
                <td class="border px-2 py-1 col-device_id">{{ d.device_id }}</td>
                <td class="border px-2 py-1 col-display_name">{{ d.display_name }}</td>
                <td class="border px-2 py-1 col-model_name">{{ d.model_name }}</td>
                <td class="border px-2 py-1 col-app_version">{{ d.app_version }}</td>
                <td class="border px-2 py-1 col-fw_version">{{ d.fw_version }}</td>
                <td class="border px-2 py-1 col-serial_number">{{ d.serial_number }}</td>
                <td class="border px-2 py-1 col-ip1">{{ d.ip1 }}</td>
                <td class="border px-2 py-1 col-mac">{{ d.mac }}</td>
                <!-- VAV data placeholders -->
                <td class="border px-2 py-1 col-vav_box_size">{{ d.vav_box_size }}</td>
                <td class="border px-2 py-1 col-damper_runtime">{{ d.damper_runtime }}</td>
                <td class="border px-2 py-1 col-cooling_min_setpoint">{{ d.cooling_min_setpoint }}</td>
                <td class="border px-2 py-1 col-cooling_max_setpoint">{{ d.cooling_max_setpoint }}</td>
                <td class="border px-2 py-1 col-heating_min_setpoint">{{ d.heating_min_setpoint }}</td>
                <td class="border px-2 py-1 col-heating_max_setpoint">{{ d.heating_max_setpoint }}</td>
                <td class="border px-2 py-1 col-standby_airflow">{{ d.standby_airflow }}</td>
                <td class="border px-2 py-1 col-damper_sensor">{{ d.damper_sensor }}</td>
                <td class="border px-2 py-1 col-controller_airflow">{{ d.controller_airflow }}</td>
                <td class="border px-2 py-1 col-airflow_setpoint">{{ d.airflow_setpoint }}</td>
                <td class="border px-2 py-1 col-damper_position">{{ d.damper_position }}</td>
                <td class="border px-2 py-1 col-damper_sensor_calibration">{{ d.damper_sensor_calibration }}</td>
                <td class="border px-2 py-1 col-flow_factor">{{ d.flow_factor }}</td>
                <td class="border px-2 py-1 col-space_temp">{{ d.space_temp }}</td>
                <td class="border px-2 py-1 col-space_temp_setpoint">{{ d.space_temp_setpoint }}</td>
                <td class="border px-2 py-1 col-discharge_temp">{{ d.discharge_temp }}</td>


            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>

    
document.addEventListener("DOMContentLoaded", function () {
    // --- VAV Box Size Map ---
    const vavBoxSizeMap = {
        1: "4 in_",
        2: "5 in_",
        3: "6 in_",
        4: "8 in_",
        5: "10 in_",
        6: "12 in_",
        7: "14 in_",
        8: "16 in_",
        9: "24x16 in_",
        10: "28x14 in_",
        11: "32x16 in_",
        12: "Other_"
    };
    const form = document.getElementById("siteSelectForm");
    const spinner = document.getElementById("loadingSpinner");

    form.addEventListener("submit", () => spinner.classList.remove("hidden"));

    const checkboxes = document.querySelectorAll('input[type="checkbox"][data-col]');
    const table = document.getElementById("deviceTable");
    const tbody = table.getElementsByTagName("tbody")[0];

    const rows = Array.from(tbody.getElementsByTagName("tr"));
    // Map vav_box_size values to string
    rows.forEach(row => {
        const cell = row.querySelector(".col-vav_box_size");
        if (cell) {
            const val = parseInt(cell.textContent.trim());
            if (!isNaN(val)) cell.textContent = vavBoxSizeMap[val] || `Unknown (${val})`;
        }
    });

    function updateColumns() {
        checkboxes.forEach(cb => {
            const colClass = 'col-' + cb.dataset.col;
            document.querySelectorAll('tbody .' + colClass).forEach(cell => cell.style.display = cb.checked ? '' : 'none');
            document.querySelectorAll('thead tr:first-child .' + colClass).forEach(th => th.style.display = cb.checked ? '' : 'none');
            const filterInput = document.querySelector('thead tr:nth-child(2) .column-filter[data-col="' + cb.dataset.col + '"]');
            if (filterInput) filterInput.closest('th').style.display = cb.checked ? '' : 'none';
            localStorage.setItem('col-' + cb.dataset.col, cb.checked);
        });
        updateDeviceCount();
    }

    checkboxes.forEach(cb => {
        const saved = localStorage.getItem('col-' + cb.dataset.col);
        if (saved !== null) cb.checked = saved === 'true';
    });

    updateColumns();
    checkboxes.forEach(cb => cb.addEventListener("change", updateColumns));

    const searchInput = document.getElementById("tableSearch");
    const columnFilters = document.querySelectorAll(".column-filter");

    function filterTable() {
        const globalFilter = searchInput.value.toLowerCase();
        const colFilters = {};
        columnFilters.forEach(input => {
            if (input.value.trim()) {
                colFilters[input.dataset.col] = input.value
                    .toLowerCase()
                    .split(",")
                    .map(v => v.trim())
                    .filter(v => v);
            }
        });

        rows.forEach(row => {
            const cells = row.getElementsByTagName("td");
            let show = true;

            if (globalFilter) {
                show = Array.from(cells).some(c => c.textContent.toLowerCase().includes(globalFilter));
            }

            if (show) {
                for (let j = 0; j < cells.length; j++) {
                    const colClass = cells[j].className.split(' ').find(c => c.startsWith('col-'));
                    const colName = colClass ? colClass.replace('col-', '') : null;
                    if (colName && colFilters[colName]) {
                        const cellText = cells[j].textContent.toLowerCase();
                        const match = colFilters[colName].some(val => {
                            if (val === '!ip') return cellText.trim() !== '';
                            if (val.startsWith('!')) return !cellText.includes(val.substring(1));
                            return cellText.includes(val);
                        });
                        if (!match) {
                            show = false;
                            break;
                        }
                    }
                }
            }

            row.style.display = show ? "" : "none";
        });

        updateDeviceCount();
    }

    const filterButtons = document.querySelectorAll('button[data-filter]');
    filterButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const filter = btn.dataset.filter;
            searchInput.value = '';
            columnFilters.forEach(input => input.value = '');

            switch (filter) {
                case "reset": break;
                case "delta": columnFilters.forEach(input => { if (input.dataset.col === 'vendor') input.value = 'delta controls'; }); break;
                case "3rdparty": columnFilters.forEach(input => { if (input.dataset.col === 'vendor') input.value = '!delta controls'; }); break;
                case "red5": columnFilters.forEach(input => { if (input.dataset.col === 'model_name') input.value = 'red5'; }); break;
                case "ebmgr": columnFilters.forEach(input => { if (input.dataset.col === 'model_name') input.value = 'ebmgr'; }); break;
                case "vav": columnFilters.forEach(input => { if (input.dataset.col === 'model_name') input.value = 'ezv,dvc,v440,v100'; }); break;
                case "dfm400p": columnFilters.forEach(input => { if (input.dataset.col === 'model_name') input.value = '400p'; }); break;
                case "ip": columnFilters.forEach(input => { if (input.dataset.col === 'ip1') input.value = '!ip'; }); break;
            }

            filterTable();
        });
    });

    function updateDeviceCount() {
        const visibleRows = rows.filter(row => row.style.display !== 'none').length;
        document.getElementById('deviceCount').textContent = visibleRows;
    }

    searchInput.addEventListener("input", filterTable);
    columnFilters.forEach(input => input.addEventListener("input", filterTable));

    // --- Export XLSX ---
document.getElementById("exportBtn").addEventListener("click", () => {
    const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
    if (!visibleRows.length) return;

    const cols = Array.from(table.querySelectorAll("thead tr:first-child th")).filter(th => th.style.display !== 'none');
    
    // Map your visible columns to desired Excel column names
    const colNameMap = {
        'vendor': 'Vendor',
        'device_id': 'Device Number',
        'display_name': 'Device Name',
        'model_name': 'Device Type',
        'app_version': 'App Version',
        'fw_version': 'Firmware',
        'serial_number': 'Serial Number',
        'ip1': 'IP Address',
        'mac': 'MAC Address',
        'ip2': 'IP Address 2',
    };

    const colKeys = cols.map(th => Array.from(th.classList).find(c => c.startsWith('col-')).replace('col-', ''));
    const excelCols = colKeys.map(key => colNameMap[key] || key);

    // Build data array
    const data = [excelCols];
    visibleRows.forEach(row => {
        const cells = Array.from(row.querySelectorAll("td")).filter(td => td.style.display !== 'none');
        const rowData = cells.map(td => td.textContent.trim());
        data.push(rowData);
    });

    // Create worksheet & workbook
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Devices");

    // Export file
    XLSX.writeFile(wb, "devices_export.xlsx");
});


        // --- Column sorting with arrow indicators ---
        let sortCol = null;
        let sortDir = 1; // 1 = asc, -1 = desc

        table.querySelectorAll('thead tr:first-child th').forEach(th => {
            th.style.cursor = 'pointer';
            
            // Create a span to hold the arrow
            let arrowSpan = document.createElement('span');
            arrowSpan.style.marginLeft = '4px';
            th.appendChild(arrowSpan);

            th.addEventListener('click', () => {
                const colClass = Array.from(th.classList).find(c => c.startsWith('col-'));
                if (!colClass) return;
                const colIndex = Array.from(th.parentNode.children).indexOf(th);

                if (sortCol === colIndex) sortDir = -sortDir; // toggle
                else sortDir = 1;
                sortCol = colIndex;

                // Remove arrow from all headers
                table.querySelectorAll('thead tr:first-child th span').forEach(span => span.textContent = '');

                // Add arrow to current header
                arrowSpan.textContent = sortDir === 1 ? '▲' : '▼';

                const sortedRows = rows.slice().sort((a, b) => {
    const aText = a.children[colIndex].textContent.trim().toLowerCase();
    const bText = b.children[colIndex].textContent.trim().toLowerCase();

    // Check if this is the IP column
            const colClass = Array.from(table.querySelectorAll('thead tr:first-child th')[colIndex].classList).find(c => c.startsWith('col-'));
                if (colClass === 'col-ip1' || colClass === 'col-ip2') {
                    // Extract last three numbers from IP
                    const extractLast3 = ip => {
                        const parts = ip.split('.').map(Number);
                        if (parts.length === 4) return parts.slice(1).join('.'); // last 3 numbers
                        return ip;
                    };
                    const aVal = extractLast3(aText);
                    const bVal = extractLast3(bText);

                    const aNums = aVal.split('.').map(Number);
                    const bNums = bVal.split('.').map(Number);
                    for (let i = 0; i < aNums.length; i++) {
                        if (aNums[i] !== bNums[i]) return sortDir * (aNums[i] - bNums[i]);
                    }
                    return 0;
                }

                // Numeric sort fallback
                if (!isNaN(aText) && !isNaN(bText)) return sortDir * (Number(aText) - Number(bText));
                return sortDir * aText.localeCompare(bText);
            });


                sortedRows.forEach(row => tbody.appendChild(row));
            });
        });
});
</script>


{% endblock %}